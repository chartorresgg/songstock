<!DOCTYPE html>
<html>

<head>
    <title>Test CORS Corregido - SongSto</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .step {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }

        .url-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>üîß Test CORS Corregido - SongSto Backend</h1>

    <div class="warning">
        <strong>‚ö†Ô∏è URL Corregida:</strong> Tu backend corre con context path <code>/api/v1</code><br>
        Base URL correcta: <code>http://localhost:8080/api/v1</code>
    </div>

    <div class="url-info">
        <strong>URLs que vamos a probar:</strong>
        <ul>
            <li>GET: <code>http://localhost:8080/api/v1/auth/test</code></li>
            <li>POST: <code>http://localhost:8080/api/v1/auth/test-cors</code></li>
            <li>POST: <code>http://localhost:8080/api/v1/auth/login</code></li>
            <li>POST: <code>http://localhost:8080/api/v1/auth/register-provider</code></li>
        </ul>
    </div>

    <div class="step">
        <h3>Paso 1: Test b√°sico de conexi√≥n</h3>
        <button onclick="testBasicConnection()">Test Conexi√≥n B√°sica</button>
        <p>Verifica si el backend responde correctamente</p>
    </div>

    <div class="step">
        <h3>Paso 2: Test endpoint CORS espec√≠fico</h3>
        <button onclick="testCorsEndpoint()">Test CORS Endpoint</button>
        <p>Verifica el filtro CORS con POST request</p>
    </div>

    <div class="step">
        <h3>Paso 3: Test login</h3>
        <button onclick="testLogin()">Test Login</button>
        <p>Intenta hacer login con credenciales de admin</p>
    </div>

    <div class="step">
        <h3>Paso 4: Test registro de proveedor</h3>
        <button onclick="testRegister()">Test Registro Proveedor</button>
        <p>Intenta registrar un proveedor nuevo</p>
    </div>

    <button onclick="clearResults()" style="background: #6c757d;">Limpiar Resultados</button>

    <div id="results"></div>

    <script>
        // ‚≠ê URL BASE CORREGIDA
        const API_BASE = 'http://localhost:8080/api/v1';
        const resultsDiv = document.getElementById('results');

        function addResult(title, content, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `
                <h4>${title}</h4>
                <pre>${content}</pre>
                <small>Tiempo: ${new Date().toLocaleTimeString()}</small>
            `;
            resultsDiv.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        async function testBasicConnection() {
            try {
                addResult('üîÑ Testeando conexi√≥n b√°sica...', 'GET /api/v1/auth/test', 'info');

                const response = await fetch(`${API_BASE}/auth/test`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/plain'
                    }
                });

                const text = await response.text();

                if (response.ok) {
                    addResult('‚úÖ Conexi√≥n b√°sica exitosa',
                        `Status: ${response.status}\nURL: ${API_BASE}/auth/test\nResponse: ${text}`, 'success');
                } else {
                    addResult('‚ö†Ô∏è Backend responde con error',
                        `Status: ${response.status}\nResponse: ${text}`, 'error');
                }

            } catch (error) {
                if (error.message.includes('CORS')) {
                    addResult('‚ùå Error CORS en conexi√≥n b√°sica',
                        `Error: ${error.message}\n\nEl filtro CORS no est√° manejando requests GET`, 'error');
                } else {
                    addResult('‚ùå Error de conexi√≥n b√°sica',
                        `Error: ${error.message}\n\nVerifica:\n1. Backend corriendo en puerto 8080\n2. Context path /api/v1 configurado\n3. CORS Filter funcionando`, 'error');
                }
            }
        }

        async function testCorsEndpoint() {
            try {
                addResult('üîÑ Testeando CORS endpoint...', 'POST /api/v1/auth/test-cors', 'info');

                const response = await fetch(`${API_BASE}/auth/test-cors`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    addResult('‚úÖ CORS endpoint exitoso',
                        `Status: ${response.status}\nURL: ${API_BASE}/auth/test-cors\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    addResult('‚ö†Ô∏è CORS endpoint con error',
                        `Status: ${response.status}\n${JSON.stringify(data, null, 2)}`, 'error');
                }

            } catch (error) {
                if (error.message.includes('CORS')) {
                    addResult('‚ùå Error CORS detectado',
                        `Error: ${error.message}\n\nEl filtro CORS no est√° funcionando para POST requests.\nVerifica que CorsFilter.java est√© creado y el backend reiniciado.`, 'error');
                } else {
                    addResult('‚ùå Error en CORS endpoint',
                        `Error: ${error.message}`, 'error');
                }
            }
        }

        async function testLogin() {
            try {
                addResult('üîÑ Testeando login...', 'POST /api/v1/auth/login', 'info');

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usernameOrEmail: 'admin',
                        password: 'admin123'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addResult('‚úÖ Login exitoso',
                        `Status: ${response.status}\nMessage: ${data.message}\nToken presente: ${!!data.data?.token}\nUser ID: ${data.data?.userId}`, 'success');
                } else {
                    addResult('‚ö†Ô∏è Login fall√≥',
                        `Status: ${response.status}\nMessage: ${data.message}\n\nPosibles causas:\n- Credenciales incorrectas\n- AuthService tiene problemas\n- Usuario admin no configurado`, 'warning');
                }

            } catch (error) {
                if (error.message.includes('CORS')) {
                    addResult('‚ùå Error CORS en login',
                        `Error: ${error.message}\n\nCORS sigue bloqueando el login`, 'error');
                } else {
                    addResult('‚ùå Error en login',
                        `Error: ${error.message}`, 'error');
                }
            }
        }

        async function testRegister() {
            try {
                addResult('üîÑ Testeando registro...', 'POST /api/v1/auth/register-provider', 'info');

                const timestamp = Date.now();
                const response = await fetch(`${API_BASE}/auth/register-provider`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "username": "testcorregido" + timestamp,
                        "email": `testcorregido${timestamp}@songstock.com`,
                        "password": "test123",
                        "firstName": "Test",
                        "lastName": "Corregido",
                        "phone": "+506-1111-2222",
                        "role": "PROVIDER",
                        "businessName": "Test Corregido Business",
                        "taxId": "123456789",
                        "address": "Test Address 123",
                        "city": "Test City",
                        "state": "Test State",
                        "country": "Colombia",
                        "postalCode": "12345"
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addResult('‚úÖ Registro exitoso',
                        `Status: ${response.status}\nMessage: ${data.message}\nUsuario creado: testcorregido${timestamp}`, 'success');
                } else {
                    addResult('‚ö†Ô∏è Registro fall√≥',
                        `Status: ${response.status}\nMessage: ${data.message}\n\nPosibles causas:\n- Error de validaci√≥n\n- Usuario ya existe\n- Error en ProviderService\n- Problema de base de datos`, 'warning');
                }

            } catch (error) {
                if (error.message.includes('CORS')) {
                    addResult('‚ùå Error CORS en registro',
                        `Error: ${error.message}\n\nCORS sigue bloqueando el registro`, 'error');
                } else {
                    addResult('‚ùå Error en registro',
                        `Error: ${error.message}`, 'error');
                }
            }
        }

        // Test autom√°tico al cargar la p√°gina
        window.addEventListener('load', function () {
            addResult('‚ÑπÔ∏è Informaci√≥n del Test',
                `Base URL: ${API_BASE}\nContext Path detectado: /api/v1\nHora de inicio: ${new Date().toLocaleString()}`, 'info');
        });
    </script>
</body>

</html>